version: 2

jobs:
  test-ruby-2.5:
    working_directory: ~/GoogleCloudPlatform/google-cloud-ruby
    shell: /bin/bash --login
    docker:
    - image: circleci/ruby:2.5.1-stretch
    steps:
    - checkout
    - run: gem update --system
    - run: gem install bundler
    - run: bundle update
    - run: bundle exec rake circleci:build
    - run: bundle exec rake circleci:post

  test-ruby-2.4:
    working_directory: ~/GoogleCloudPlatform/google-cloud-ruby
    shell: /bin/bash --login
    docker:
    - image: circleci/ruby:2.4.4-stretch
    steps:
    - checkout
    - run: gem update --system
    - run: gem install bundler
    - run: bundle update
    - run: bundle exec rake circleci:build
    - run: bundle exec rake test:coveralls

  test-ruby-2.3:
    working_directory: ~/GoogleCloudPlatform/google-cloud-ruby
    shell: /bin/bash --login
    docker:
    - image: circleci/ruby:2.3.7-stretch
    steps:
    - checkout
    - run: gem update --system
    - run: gem install bundler
    - run: bundle update
    - run: bundle exec rake circleci:build

  release:
    working_directory: ~/GoogleCloudPlatform/google-cloud-ruby
    shell: /bin/bash --login
    docker:
    - image: circleci/ruby:2.5.1-stretch
    steps:
    - checkout
    - run: gem update --system
    - run: gem install bundler
    - run: bundle update
    - run: bundle exec rake circleci:release

workflows:
  version: 2
  tests:
    jobs:
      - test-ruby-2.5: &test-filters
          filters:
            branches:
              ignore:
                - gh-pages
                - gcloud-jsondoc
                - gcloud-rdoc
                - yard-gcloud
      - test-ruby-2.4:
          <<: *test-filters
      - test-ruby-2.3:
          <<: *test-filters
  gem-release:
    jobs:
      - release:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /\S+\/v\S+/

notify:
  webhooks:
    - url: https://coveralls.io/webhook?repo_token=VdG8EataF3PrWBZOBH7Hr80BXUjYRLh7o
